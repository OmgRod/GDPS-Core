#############################################
# Server: Port 80 - frontend + backend proxy
#############################################
server {
  listen 80;
  server_name _;

  # use variables for upstreams so nginx resolves service names at request time
  set $backend_upstream backend:3000;
  set $frontend_upstream frontend:80;

  # Proxy API requests to backend
  location ^~ /api/ {
    proxy_pass http://$backend_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_connect_timeout 5s;
    proxy_read_timeout 30s;
    proxy_send_timeout 10s;
    proxy_set_header Connection "";
  }

  # Proxy everything else to the frontend service (SPA)
  location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_pass http://$frontend_upstream;
  }
}

#############################################
# Server: Port 5555 - Prisma Studio (root path)
#############################################
server {
  listen 5555;
  server_name _;

  # prisma upstream (internal container)
  set $prisma_upstream prisma:5555;

  # Protect Studio with Basic auth using generated /etc/nginx/.htpasswd
  location / {
    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_pass http://$prisma_upstream/;
  }
}
